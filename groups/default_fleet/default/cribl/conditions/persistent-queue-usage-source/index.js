exports.name="Persistent Queue Usage";exports.type="metric";exports.category="sources";let id;let name;let __workerGroup;let timeWindow;let usageThreshold;let usageThresholdDecimal;let notifyOnResolution;exports.init=e=>{id=e.pid;const i=e.conf||{};({name,__workerGroup,timeWindow,usageThreshold,notifyOnResolution}=i);timeWindow=timeWindow||"60s";usageThreshold=usageThreshold!=null?usageThreshold:90;usageThresholdDecimal=usageThreshold/100;notifyOnResolution=notifyOnResolution||false};exports.build=()=>{let e="";let i=`_metric === 'system.pq_used' && input === '${name}'`;let s=`'Source ${name} persistent queue usage greater than ${usageThreshold}% threshold in ${timeWindow}'`;let o=`'Source ${name} persistent queue usage is within ${usageThreshold}% threshold in ${timeWindow}'`;if(__workerGroup){i=`${i} && __worker_group === '${__workerGroup}'`;e=` in group ${__workerGroup}`;s=`'Source ${name}${e} persistent queue usage greater than ${usageThreshold}% threshold in ${timeWindow}'`;o=`'Source ${name}${e} persistent queue usage is within ${usageThreshold}% threshold in ${timeWindow}'`}return{filter:i,pipeline:{conf:{functions:[{id:"aggregation",conf:{timeWindow,aggregations:["last(_value).as(queue_usage)"],lagTolerance:"20s",idleTimeLimit:"20s"}},{id:"eval",conf:{add:[{name:"input",value:`'${name}'`},{name:"timewindow",value:`'${timeWindow}'`},{name:"usageThreshold",value:`'${usageThreshold}'`},{name:"_metric",value:"'system.pq_used'"},{name:"usage",value:"`${queue_usage * 100}`"}]}},{id:"eval",filter:`queue_usage > ${usageThresholdDecimal}`,conf:{add:[{name:"_raw",value:`${s}`},{name:"status",value:`'ALARM'`}]}},{id:"eval",filter:`typeof queue_usage === 'undefined' || queue_usage <= ${usageThresholdDecimal}`,conf:{add:[{name:"_raw",value:`${o}`},{name:"status",value:`'OK'`}]}},{id:"notifications",conf:{id,field:"status",deduplicate:notifyOnResolution}},{id:"drop",filter:`!(${notifyOnResolution}) && status === 'OK'`}]}}}};