const{Expression}=C.expr;const cLogger=C.util.getLogger("func:suppress");exports.name="Suppress";exports.version="0.2";exports.disabled=false;exports.group="Standard";exports.sync=true;exports.handleSignals=true;let _primaryCache=new Map;let _secondaryCache=new Map;let _expression=null;let _numToAllow;let _suppressionMs;let _dropEvents=true;let _numEventsReceived=0;let _cacheExpirationMs;let _maxCacheSize;let _cacheCleanupNumEvents;function getCacheEntry(e,n){let s=_primaryCache.get(e);if(!s){s=_secondaryCache.get(e);if(s){_primaryCache.set(e,s)}else{const r=n+_suppressionMs;s={count:0,expirationTime:r};_primaryCache.set(e,s)}}return s}function cleanCache(){_secondaryCache=_primaryCache;_primaryCache=new Map}exports.init=e=>{const n=e.conf;const s=n.keyExpr||"";_numToAllow=n.allow||1;_suppressionMs=Number(n.suppressPeriodSec*1e3)||300*1e3;_maxCacheSize=n.maxCacheSize||5e4;_cacheCleanupNumEvents=n.numEventsIdleTimeoutTrigger||1e5;const r=n.cacheIdleTimeoutPeriods||2;_cacheExpirationMs=_suppressionMs*Number(r);_dropEvents=n.dropEventsMode===undefined||Boolean(n.dropEventsMode);if(s.length>0){_expression=new Expression(s,{disallowAssign:true})}_primaryCache=new Map;_secondaryCache=new Map;_numEventsReceived=0;cLogger.info("initialized suppress function",{keyExpr:s,numToAllow:_numToAllow,dropEventsMode:_dropEvents,supressionMs:_suppressionMs,cacheExpirationMs:_cacheExpirationMs,maxCacheSize:_maxCacheSize,cacheCleanupNumEvents:_cacheCleanupNumEvents})};exports.process=e=>{if(!_expression||!e){if(e){e.suppress=0}return e}if(e.__signalEvent__){cLogger.debug("signal event received",{event:e.__signalEvent__});if(e.__signalEvent__==="reset"){exports.unload()}return e}const n=_expression.evalOn(e);if(n===undefined||n===null){e.suppress=0;return e}_numEventsReceived++;if(_numEventsReceived%_cacheCleanupNumEvents===0&&_primaryCache.size>=_maxCacheSize){cleanCache()}const s=C.util.getEventTimeInMs(e)||Date.now();const r=getCacheEntry(n,s);if(r.count===0){r.count=1;e.suppress=0;return e}let t=false;const o=r.count>_numToAllow?r.count-_numToAllow:0;if(s>r.expirationTime){r.expirationTime=s+_suppressionMs;r.count=0;t=true}if(r.count<_numToAllow){r.count++;e.suppress=0;if(t&&o>0){e.suppressCount=o}return e}r.count++;if(_dropEvents){return undefined}e.suppress=1;e.suppressCount=o+1;return e};exports.unload=()=>{_numEventsReceived=0;_primaryCache=new Map;_secondaryCache=new Map};exports.getCacheSize=()=>_primaryCache.size;